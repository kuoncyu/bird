<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£é³¥é¡å…¨åœ–é‘‘ (æ‰‹æ©Ÿè§¸æ§ä¿®å¾©ç‰ˆ)</title>
    <style>
        :root {
            --primary: #006064;
            --secondary: #0097a7;
            --accent: #fbc02d;
            --bg: #f1f8e9;
            --text: #37474f;
            --card-bg: #ffffff;
            
            --status-common: #689f38;
            --status-endemic: #7b1fa2;
            --status-rare: #d32f2f;
            --status-winter: #1976d2;
            --status-invasive: #616161;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "Noto Sans TC", "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, #004d40, #00695c);
            color: white;
            padding: 1.2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: sticky; top: 0; z-index: 100;
        }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1.5px; }
        .subtitle { font-size: 0.8rem; opacity: 0.9; margin-top: 5px; }

        /* --- Navigation --- */
        .nav {
            display: flex; 
            justify-content: flex-start;
            gap: 10px; 
            padding: 10px 15px;
            background: white; 
            border-bottom: 1px solid #c8e6c9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky; top: 78px; z-index: 90;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .nav::-webkit-scrollbar { display: none; }
        
        .nav-btn {
            padding: 8px 18px; border: none; border-radius: 50px;
            background: #eceff1; color: #546e7a; cursor: pointer;
            font-weight: bold; transition: all 0.2s; 
            font-size: 0.9rem; white-space: nowrap; flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .nav-btn.active {
            background: var(--secondary); color: white;
            box-shadow: 0 2px 5px rgba(0, 151, 167, 0.3);
        }

        .container { 
            max-width: 1000px; margin: 0 auto; padding: 15px; 
            min-height: 80vh;
        }
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Daily Card (Mobile Fix) --- */
        .daily-container { width: 100%; max-width: 480px; margin: 0 auto; text-align: center; }
        
        .card-scene {
            perspective: 1000px;
            width: 100%; 
            height: min(580px, 65vh);
            margin: 20px auto; 
            position: relative;
        }
        .card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-style: preserve-3d;
        }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; 
            /* ä¿®æ­£ï¼šéš±è—èƒŒé¢æ™‚ä¸æ¥å—é»æ“Šï¼Œè§£æ±ºæ‰‹æ©Ÿèª¤è§¸ */
            -webkit-backface-visibility: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden;
            background: white;
        }
        
        /* é—œéµä¿®æ­£ï¼šé€é CSS æ§åˆ¶é»æ“Šç©¿é€ */
        .card-front {
            background: linear-gradient(135deg, #004d40, #00897b);
            color: white; border: 4px solid #e0f2f1;
            z-index: 2;
            cursor: pointer;
        }
        .card-back {
            transform: rotateY(180deg);
            padding: 0; justify-content: flex-start;
            border: 1px solid #ddd;
            background: #fdfdfd;
            z-index: 1;
        }
        
        /* ç•¶ç¿»è½‰å¾Œï¼Œæ­£é¢ä¸èƒ½é»ï¼ŒèƒŒé¢å¯ä»¥é» */
        .card-inner.is-flipped .card-front { pointer-events: none; }
        .card-inner.is-flipped .card-back { pointer-events: auto; }
        
        .daily-img-wrapper { 
            width: 100%; 
            height: 55%; 
            background: #263238; 
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: zoom-in; /* æç¤ºå¯ä»¥é»æ“Š */
        }
        .daily-img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block;
        }
        .zoom-hint {
            position: absolute;
            bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.6);
            color: white; padding: 6px 10px;
            border-radius: 20px; font-size: 0.75rem;
            pointer-events: none;
            display: flex; align-items: center; gap: 5px;
        }

        .daily-info-box { 
            padding: 20px; text-align: left; height: 45%; 
            overflow-y: auto; box-sizing: border-box; 
            -webkit-overflow-scrolling: touch;
        }
        .daily-date { 
            background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; 
            margin-bottom: 20px; font-size: 0.9rem; letter-spacing: 1px; 
        }

        /* --- Tools & Grid --- */
        .tools-bar {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;
            border: 1px solid #dcedc8;
        }
        .search-box {
            width: 100%; padding: 10px; border: 2px solid #cfd8dc;
            border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 12px;
            -webkit-appearance: none;
        }
        .filter-scroll { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; 
            scrollbar-width: none; -webkit-overflow-scrolling: touch;
        }
        .filter-tag {
            white-space: nowrap; padding: 6px 14px; border-radius: 15px;
            background: #f1f8e9; border: 1px solid #c5e1a5; cursor: pointer; 
            font-size: 0.85rem; color: #33691e; flex-shrink: 0;
        }
        .filter-tag.active { background: var(--secondary); color: white; border-color: var(--secondary); }

        .bird-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px; 
        }
        .bird-card {
            background: var(--card-bg); border-radius: 12px; padding: 15px 10px; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; 
            border: 1px solid #f1f1f1;
            display: flex; flex-direction: column; justify-content: center; min-height: 110px;
            position: relative;
        }
        @media (hover: hover) {
            .bird-card:hover { transform: translateY(-5px); border-color: var(--secondary); box-shadow: 0 10px 15px -5px rgba(0,0,0,0.1); transition: 0.2s; }
        }
        .bird-card:active { transform: scale(0.98); background: #f9f9f9; }

        .b-name { font-weight: bold; font-size: 1rem; color: #006064; margin-bottom: 5px; }
        .b-cat { font-size: 0.75rem; color: #78909c; margin-bottom: 8px; }
        
        .status-badge {
            font-size: 0.7rem; color: white; padding: 3px 8px; border-radius: 10px;
            display: inline-block; font-weight: bold; margin-top: auto;
        }
        .st-endemic { background: var(--status-endemic); }
        .st-common { background: var(--status-common); }
        .st-rare { background: var(--status-rare); }
        .st-winter { background: var(--status-winter); }
        .st-invasive { background: var(--status-invasive); }

        /* --- Quiz --- */
        .quiz-panel {
            background: white; padding: 25px 20px; border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center;
            max-width: 600px; margin: 0 auto; border: 1px solid #eee;
        }
        .q-media-box {
            height: 280px; background: #fafafa; border: 2px dashed #cfd8dc;
            border-radius: 12px; margin: 20px 0; display: flex;
            align-items: center; justify-content: center; position: relative; overflow: hidden;
        }
        .full-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        
        .opt-btn {
            width: 100%; padding: 14px; margin-bottom: 10px; background: white;
            border: 2px solid #cfd8dc; border-radius: 10px; font-size: 0.95rem;
            cursor: pointer; font-weight: bold; color: #455a64;
            touch-action: manipulation;
        }
        .opt-btn:active { background: #eceff1; }
        .opt-btn.correct { background: #c8e6c9; border-color: #66bb6a; color: #1b5e20; }
        .opt-btn.wrong { background: #ffcdd2; border-color: #ef5350; color: #b71c1c; }

        /* --- Modal --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: none; justify-content: center; align-items: center; padding: 15px;
            backdrop-filter: blur(5px);
            /* ä¿®æ­£æ‰‹æ©Ÿé»æ“Š */
            touch-action: none;
        }
        .modal-box {
            background: white; width: 100%; max-width: 500px;
            border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
            max-height: 85vh; 
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .img-area { 
            height: 40vh; 
            background: #000; display: flex; align-items: center; justify-content: center; 
        }
        .info-area { padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid var(--secondary);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .reveal-box {
            background: #e0f2f1; border: 1px solid #b2dfdb; border-radius: 12px;
            padding: 15px; text-align: left; margin-top: 15px; display: none;
        }

        @media (min-width: 768px) {
            .container { padding: 30px; }
            .bird-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .nav { justify-content: center; top: 85px; }
            .card-scene { height: 550px; }
            h1 { font-size: 2rem; }
            .img-area { height: 300px; }
        }

    </style>
</head>
<body>

<header>
    <h1>ğŸŒ¿ å°ç£é³¥é¡å…¨åœ–é‘‘</h1>
    <div class="subtitle">è¡Œå‹•ç‰ˆ â€¢ æ¯æ—¥é‹å‹¢ â€¢ 80+ ç‰©ç¨®</div>
</header>

<div class="nav">
    <button class="nav-btn" onclick="setTab('guide', this)">ğŸ“– ç”Ÿæ…‹åœ–é‘‘</button>
    <button class="nav-btn active" onclick="setTab('daily', this)">ğŸ”® æ¯æ—¥ä¸€é³¥</button>
    <button class="nav-btn" onclick="setTab('quiz', this)">ğŸ“¸ çœ¼åŠ›æ¸¬é©—</button>
</div>

<div class="container">

    <div id="sec-guide" class="section">
        <div class="tools-bar">
            <input type="text" id="search-input" class="search-box" placeholder="æœå°‹ (å¦‚ï¼šç™½é ­ç¿)..." onkeyup="renderGuide()">
            <div class="filter-scroll">
                <div class="filter-tag active" onclick="setFilter('all', this)">å…¨éƒ¨</div>
                <div class="filter-tag" onclick="setFilter('ç‰¹æœ‰ç¨®', this)">ç‰¹æœ‰ç¨®</div>
                <div class="filter-tag" onclick="setFilter('å¸¸è¦‹', this)">å¸¸è¦‹/åŸå¸‚</div>
                <div class="filter-tag" onclick="setFilter('çŒ›ç¦½', this)">çŒ›ç¦½</div>
                <div class="filter-tag" onclick="setFilter('æ°´é³¥', this)">æ°´é³¥</div>
                <div class="filter-tag" onclick="setFilter('å±±æ—', this)">å±±æ—</div>
                <div class="filter-tag" onclick="setFilter('å€™é³¥', this)">å€™é³¥</div>
            </div>
            <div style="text-align:right; font-size:0.75rem; color:#888; margin-top:8px;">
                æ”¶éŒ„ï¼š<span id="db-count">0</span> ç¨®
            </div>
        </div>
        <div id="guide-grid" class="bird-grid"></div>
    </div>

    <div id="sec-daily" class="section active">
        <div class="daily-container">
            <h2 style="color:var(--primary); margin: 0 0 5px 0; font-size: 1.3rem;">ğŸ“… ä»Šå¤©çš„å°ˆå±¬é³¥æœ‹å‹</h2>
            <p style="color:#666; font-size:0.85rem; margin-top: 0;">é»æ“Šå¡ç‰‡ç¿»é–‹ï¼Œçœ‹çœ‹ä»Šå¤©æ˜¯èª°ï¼Ÿ</p>
            
            <div class="card-scene">
                <div class="card-inner" id="daily-card-inner">
                    <div class="card-face card-front" onclick="flipDailyCard()">
                        <div style="font-size:4rem; margin-bottom:10px; text-shadow: 0 4px 10px rgba(0,0,0,0.3);">ğŸª¶</div>
                        <h2 style="letter-spacing: 2px; font-size: 1.5rem;">DAILY BIRD</h2>
                        <div class="daily-date" id="daily-date-display">...</div>
                        <p style="opacity: 0.9; font-size: 0.9rem;">é»æ“Šç¿»é–‹</p>
                    </div>
                    
                    <div class="card-face card-back">
                        <div class="daily-img-wrapper" onclick="openDailyZoom()">
                            <img id="daily-img" class="daily-img" src="" alt="Bird">
                            <div class="loader" id="daily-loader" style="position:absolute; top:45%; left:45%;"></div>
                            <div class="zoom-hint">ğŸ” é»åœ–æ”¾å¤§</div>
                        </div>
                        <div class="daily-info-box">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h2 id="daily-name" style="margin:0; color:var(--primary); font-size: 1.4rem;">è¼‰å…¥ä¸­...</h2>
                                <span id="daily-status" class="status-badge"></span>
                            </div>
                            <p id="daily-eng" style="color:#78909c; font-style:italic; font-size:0.85rem; margin-top:2px;"></p>
                            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                            <p id="daily-desc" style="line-height:1.6; color:#546e7a; font-size:0.9rem;">
                                é€£ç·šä¸­...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="sec-quiz" class="section">
        <div id="quiz-menu" class="quiz-panel">
            <h2 style="color:var(--primary); font-size: 1.4rem;">ğŸ¦… é³¥é¡è¾¨è­˜å¤§æŒ‘æˆ°</h2>
            <p style="font-size: 0.95rem; color: #555;">ä½ èªè­˜å¤šå°‘å°ç£çš„é£›ç¾½ç²¾éˆï¼Ÿ</p>
            <br>
            <div style="font-size:3.5rem; margin-bottom:15px;">ğŸ¦‰</div>
            <button class="nav-btn" style="background:var(--secondary); color:white; width:100%; padding:15px; font-size:1.1rem;" onclick="startQuiz()">
                é–‹å§‹æŒ‘æˆ°
            </button>
        </div>

        <div id="quiz-play" class="quiz-panel" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; color:#78909c; font-size: 0.9rem;">
                <span id="q-progress">1 / 10</span>
                <span>åˆ†æ•¸: <span id="q-score">0</span></span>
            </div>
            
            <h3 style="margin:0; color:#37474f; font-size: 1.2rem;">é€™éš»é³¥æ˜¯ï¼Ÿ</h3>
            <div id="skip-indicator" class="skip-msg">âš ï¸ è®€å–å¤±æ•—ï¼Œè‡ªå‹•è£œé¡Œ</div>

            <div class="q-media-box">
                <div class="loader" id="v-loader"></div>
                <img id="q-img" class="full-img">
            </div>

            <div id="opt-container"></div>
            <div id="feedback" style="height:25px; font-weight:bold; margin-top:5px; font-size: 1rem;"></div>

            <div id="reveal-card" class="reveal-box">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong id="rev-name" style="font-size:1.2rem; color:var(--primary);"></strong>
                    <span id="rev-status" class="status-badge"></span>
                </div>
                <p id="rev-desc" style="font-size:0.9rem; margin-top:8px; color:#455a64; line-height:1.5;"></p>
                <a id="rev-link" href="#" target="_blank" style="font-size:0.85rem; display:block; margin-top:10px; color:var(--secondary); font-weight:bold;">ğŸ“– æŸ¥çœ‹ç™¾ç§‘</a>
            </div>

            <button id="next-btn" class="nav-btn" style="width:100%; background:var(--secondary); color:white; margin-top:15px; display:none;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â†’</button>
            <button onclick="quitQuiz()" style="background:none; border:none; margin-top:15px; color:#90a4ae; text-decoration:underline; cursor:pointer; font-size: 0.9rem;">é€€å‡º</button>
        </div>

        <div id="quiz-result" class="quiz-panel" style="display:none;">
            <h2>ğŸ† æŒ‘æˆ°å®Œæˆ</h2>
            <p>æœ¬æ¬¡å¾—åˆ†</p>
            <h1 id="final-score" style="font-size:3.5rem; margin:10px 0; color:var(--primary);">0</h1>
            <div id="final-rank" style="font-size:1rem; background:var(--accent); color:#37474f; padding:6px 20px; border-radius:20px; display:inline-block; font-weight:bold;"></div>
            <br><br>
            <button class="nav-btn" onclick="quitQuiz()">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>

</div>

<div id="modal" class="modal" onclick="closeModal(event)">
    <div class="modal-box">
        <div class="img-area">
            <div class="loader" id="m-loader"></div>
            <img id="m-img" class="full-img">
            <div id="m-err" style="display:none; color:white;">ç„¡åœ–ç‰‡è³‡æ–™</div>
        </div>
        <div class="info-area">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <h2 id="m-name" style="margin:0; color:var(--primary); font-size: 1.5rem;"></h2>
                <span id="m-status" class="status-badge" style="margin:0;"></span>
            </div>
            <div id="m-latin" style="color:#78909c; font-style:italic; margin-bottom:10px; margin-top:2px; font-size: 0.9rem;"></div>
            <p id="m-desc" style="line-height:1.6; color:#455a64; font-size: 0.95rem;">è®€å–ä¸­...</p>
            
            <a id="m-wiki" href="#" target="_blank" style="display:block; text-align:center; margin-top:20px; padding:12px; background:#e0f2f1; color:var(--primary); text-decoration:none; border-radius:8px; font-weight:bold;">å‰å¾€ç¶­åŸºç™¾ç§‘é–±è®€æ›´å¤š</a>
        </div>
        <button onclick="closeModal(null)" style="width:100%; padding:15px; border:none; background:#eceff1; color:#78909c; cursor:pointer; font-size:1rem; border-top:1px solid #ddd; font-weight: bold;">é—œé–‰è¦–çª—</button>
    </div>
</div>

<script>
    // --- 1. å°ç£é³¥é¡å®Œæ•´è³‡æ–™åº« ---
    const birds = [
        // ç‰¹æœ‰ç¨®
        { name: "è‡ºç£è—éµ²", eng: "Urocissa caerulea", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®" },
        { name: "å¸é›‰", eng: "Syrmaticus mikado", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®/ç€•å±" },
        { name: "è—è…¹é·´", eng: "Lophura swinhoii", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®/çè²´" },
        { name: "æ·±å±±ç«¹é›", eng: "Arborophila crudigularis", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®" },
        { name: "äº”è‰²é³¥", eng: "Psilopogon nuchalis", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®/æ™®é", wikiTerm: "å°ç£æ“¬å•„æœ¨" },
        { name: "é»ƒå±±é›€", eng: "Machlolophus holsti", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®/ç¨€æœ‰" },
        { name: "å† ç¾½ç•«çœ‰", eng: "Yuhina brunneiceps", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®/æ™®é" },
        { name: "ç™½è€³ç•«çœ‰", eng: "Heterophasia auricularis", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®" },
        { name: "è—ªé³¥", eng: "Liocichla steerii", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®" },
        { name: "é‡‘ç¿¼ç™½çœ‰", eng: "Trochalopteron morrisonianum", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®/æ™®é", wikiTerm: "å°ç£å™ªçœ‰" },
        { name: "ç´«å˜¯é¶‡", eng: "Myophonus insularis", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®" },
        { name: "çƒé ­ç¿", eng: "Pycnonotus taivanus", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®/èŠ±æ±é™å®š" },
        { name: "ç«å† æˆ´èŠ", eng: "Regulus goodfellowi", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®" },
        { name: "æ —èƒŒæ—é´", eng: "Tarsiger johnstoniae", cat: "ç‰¹æœ‰ç¨®", status: "ç‰¹æœ‰ç¨®" },
        // å¸¸è¦‹
        { name: "éº»é›€", eng: "Passer montanus", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "ç™½é ­ç¿", eng: "Pycnonotus sinensis", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥", wikiTerm: "ç™½é ­éµ¯" },
        { name: "ç¶ ç¹¡çœ¼", eng: "Zosterops japonicus", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "ç é ¸æ–‘é³©", eng: "Spilopelia chinensis", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "ç´…é³©", eng: "Streptopelia tranquebarica", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "å¤§æ²å°¾", eng: "Dicrurus macrocercus", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "å–œéµ²", eng: "Pica serica", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "æ¨¹éµ²", eng: "Dendrocitta formosae", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "å®¶ç‡•", eng: "Hirundo rustica", cat: "å¸¸è¦‹", status: "æ™®éå¤å€™é³¥" },
        { name: "é»‘å† éº»é·º", eng: "Gorsachius melanolophus", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "ç™½é¶ºé´’", eng: "Motacilla alba", cat: "å¸¸è¦‹", status: "æ™®éç•™é³¥" },
        { name: "å®¶å…«å“¥", eng: "Acridotheres tristis", cat: "å¸¸è¦‹", status: "å¤–ä¾†ç¨®" },
        { name: "ç™½å°¾å…«å“¥", eng: "Acridotheres javanicus", cat: "å¸¸è¦‹", status: "å¤–ä¾†ç¨®" },
        // çŒ›ç¦½
        { name: "å¤§å† é·²", eng: "Spilornis cheela", cat: "çŒ›ç¦½", status: "æ™®éç•™é³¥" },
        { name: "é³³é ­è’¼é·¹", eng: "Accipiter trivirgatus", cat: "çŒ›ç¦½", status: "æ™®éç•™é³¥" },
        { name: "é»‘é³¶", eng: "Milvus migrans", cat: "çŒ›ç¦½", status: "çè²´ç¨€æœ‰" },
        { name: "é­šé·¹", eng: "Pandion haliaetus", cat: "çŒ›ç¦½", status: "ä¸æ™®éå†¬å€™é³¥", wikiTerm: "é¶š" },
        { name: "é ˜è§’é´", eng: "Otus lettia", cat: "çŒ›ç¦½", status: "æ™®éç•™é³¥" },
        { name: "é»ƒå˜´è§’é´", eng: "Otus spilocephalus", cat: "çŒ›ç¦½", status: "æ™®éç•™é³¥" },
        { name: "éµ‚é¶¹", eng: "Glaucidium brodiei", cat: "çŒ›ç¦½", status: "çè²´ç¨€æœ‰" },
        { name: "ç´…éš¼", eng: "Falco tinnunculus", cat: "çŒ›ç¦½", status: "æ™®éå†¬å€™é³¥" },
        { name: "éŠéš¼", eng: "Falco peregrinus", cat: "çŒ›ç¦½", status: "ç¨€æœ‰" },
        { name: "ç°é¢éµŸé·¹", eng: "Butastur indicus", cat: "çŒ›ç¦½", status: "æ™®ééå¢ƒé³¥", wikiTerm: "ç°é¢éµŸé·¹" },
        { name: "æ±æ–¹èœ‚é·¹", eng: "Pernis ptilorhynchus", cat: "çŒ›ç¦½", status: "éå¢ƒ/ç•™é³¥" },
        // æ°´é³¥
        { name: "å°ç™½é·º", eng: "Egretta garzetta", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "å¤§ç™½é·º", eng: "Ardea alba", cat: "æ°´é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "è’¼é·º", eng: "Ardea cinerea", cat: "æ°´é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "å¤œé·º", eng: "Nycticorax nycticorax", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "é»ƒé ­é·º", eng: "Bubulcus ibis", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "ç¿ é³¥", eng: "Alcedo atthis", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "ç´…å† æ°´é›", eng: "Gallinula chloropus", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "ç™½è…¹ç§§é›", eng: "Amaurornis phoenicurus", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "é«˜è¹ºé´´", eng: "Himantopus himantopus", cat: "æ°´é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "æ±æ–¹ç’°é ¸é´´", eng: "Charadrius alexandrinus", cat: "æ°´é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "å°ç’°é ¸é´´", eng: "Charadrius dubius", cat: "æ°´é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "èŠ±å˜´é´¨", eng: "Anas zonorhyncha", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "å°æ°´é´¨", eng: "Anas crecca", cat: "æ°´é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "å°é·¿é·‰", eng: "Tachybaptus ruficollis", cat: "æ°´é³¥", status: "æ™®éç•™é³¥" },
        { name: "é»‘é¢çµé·º", eng: "Platalea minor", cat: "æ°´é³¥", status: "ç€•å±/å†¬å€™é³¥" },
        { name: "ç£¯é·¸", eng: "Actitis hypoleucos", cat: "æ°´é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "æ°´é›‰", eng: "Hydrophasianus chirurgus", cat: "æ°´é³¥", status: "çè²´ç¨€æœ‰/ç•™é³¥" },
        { name: "åŸƒåŠè–æœ±é·º", eng: "Threskiornis aethiopicus", cat: "æ°´é³¥", status: "å¤–ä¾†ç¨®/ç§»é™¤ä¸­" },
        // å±±æ—
        { name: "ç´…å˜´é»‘éµ¯", eng: "Hypsipetes leucocephalus", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "é»‘æ•è—é¶²", eng: "Hypothymis azurea", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "å°æ²å°¾", eng: "Dicrurus aeneus", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "ç¹¡çœ¼ç•«çœ‰", eng: "Alcippe morrisonia", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "å±±ç´…é ­", eng: "Cyanoderma ruficeps", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "å°å½å˜´", eng: "Pomatorhinus musicus", cat: "å±±æ—", status: "ç‰¹æœ‰ç¨®/æ™®é" },
        { name: "å¤§å½å˜´", eng: "Erythrogenys erythrocnemis", cat: "å±±æ—", status: "ç‰¹æœ‰ç¨®/æ™®é" },
        { name: "å·¨å˜´é´‰", eng: "Corvus macrorhynchos", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "èµ¤è…¹å±±é›€", eng: "Sittiparus castaneoventris", cat: "å±±æ—", status: "ç‰¹æœ‰ç¨®/æ™®é" },
        { name: "é’èƒŒå±±é›€", eng: "Parus monticolus", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "èŒ¶è…¹é³¾", eng: "Sitta europaea", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "å…«è‰²é³¥", eng: "Pitta nympha", cat: "å±±æ—", status: "çè²´ç¨€æœ‰/å¤å€™é³¥" },
        { name: "ç°å–‰å±±æ¤’é³¥", eng: "Pericrocotus solaris", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        { name: "ç¿ ç¿¼é³©", eng: "Chalcophaps indica", cat: "å±±æ—", status: "æ™®éç•™é³¥" },
        // å€™é³¥
        { name: "ç´…å°¾ä¼¯å‹", eng: "Lanius cristatus", cat: "å€™é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "ç°é¶ºé´’", eng: "Motacilla cinerea", cat: "å€™é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "é»ƒé¶ºé´’", eng: "Motacilla tschutschensis", cat: "å€™é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "èµ¤è…¹é¶‡", eng: "Turdus chrysolaus", cat: "å€™é³¥", status: "æ™®éå†¬å€™é³¥" },
        { name: "ç™½çœ‰é¶‡", eng: "Turdus obscurus", cat: "å€™é³¥", status: "æ™®éå†¬å€™é³¥" }
    ];

    // --- Helper Functions ---
    function getStatusClass(status) {
        if (status.includes("ç‰¹æœ‰ç¨®")) return "st-endemic";
        if (status.includes("å¤–ä¾†ç¨®")) return "st-invasive";
        if (status.includes("ç¨€æœ‰") || status.includes("ç€•å±") || status.includes("çè²´")) return "st-rare";
        if (status.includes("å€™é³¥") || status.includes("éå¢ƒ")) return "st-winter";
        return "st-common";
    }

    const getWikiData = async (birdName, wikiTerm = null) => {
        try {
            const term = wikiTerm || birdName;
            const res = await fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(term)}`);
            if(!res.ok) throw new Error();
            return await res.json();
        } catch(e) { return null; }
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        renderGuide();
        document.getElementById('db-count').innerText = birds.length;
        
        // æ¯æ—¥ä¸€é³¥æ—¥æœŸ
        const today = new Date();
        const dateStr = `${today.getFullYear()} / ${today.getMonth()+1} / ${today.getDate()}`;
        document.getElementById('daily-date-display').innerText = dateStr;
    });

    // --- Tab Switching ---
    function setTab(tab, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`sec-${tab}`).classList.add('active');
        btn.classList.add('active');
        window.scrollTo(0, 0);

        if (tab !== 'quiz') quitQuiz();
    }

    // --- Guide ---
    let currentFilter = 'all';
    function renderGuide() {
        const grid = document.getElementById('guide-grid');
        grid.innerHTML = '';
        const term = document.getElementById('search-input').value.toLowerCase();
        
        const list = birds.filter(b => {
            let matchCat = false;
            if(currentFilter === 'all') matchCat = true;
            else if(currentFilter === 'å€™é³¥') matchCat = b.status.includes('å€™é³¥') || b.status.includes('éå¢ƒ');
            else matchCat = b.cat.includes(currentFilter);
            
            const matchSearch = b.name.includes(term) || b.eng.toLowerCase().includes(term);
            return matchCat && matchSearch;
        });

        list.forEach(b => {
            const el = document.createElement('div');
            el.className = 'bird-card';
            el.innerHTML = `
                <div class="b-name">${b.name}</div>
                <div class="b-cat">${b.cat}</div>
                <div class="status-badge ${getStatusClass(b.status)}">${b.status}</div>
            `;
            el.onclick = () => openModal(b);
            grid.appendChild(el);
        });
    }

    function setFilter(cat, btn) {
        currentFilter = cat;
        document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        renderGuide();
    }

    // --- Daily Card Logic (Separated Events) ---
    let isDailyFlipped = false;
    let currentDailyBird = null;

    function flipDailyCard() {
        if (isDailyFlipped) return; // å·²ç¶“ç¿»é–‹å°±ä¸å†å‹•ä½œ
        
        const cardInner = document.getElementById('daily-card-inner');
        cardInner.classList.add('is-flipped');
        isDailyFlipped = true;
        
        loadDailyBirdData();
    }
    
    // æ–°å¢ï¼šç¨ç«‹çš„æ”¾å¤§å‡½å¼
    function openDailyZoom() {
        if (!currentDailyBird) return; // è³‡æ–™é‚„æ²’è¼‰å…¥
        openModal(currentDailyBird);
    }

    async function loadDailyBirdData() {
        const todayStr = new Date().toDateString(); 
        let hash = 0;
        for (let i = 0; i < todayStr.length; i++) hash = todayStr.charCodeAt(i) + ((hash << 5) - hash);
        const seed = Math.abs(hash); 
        const birdIndex = seed % birds.length;
        const bird = birds[birdIndex];
        currentDailyBird = bird; // å„²å­˜è³‡æ–™ä¾›æ”¾å¤§ç”¨

        document.getElementById('daily-name').innerText = bird.name;
        document.getElementById('daily-eng').innerText = bird.eng;
        
        const badge = document.getElementById('daily-status');
        badge.innerText = bird.status;
        badge.className = `status-badge ${getStatusClass(bird.status)}`;

        const data = await getWikiData(bird.name, bird.wikiTerm);
        const img = document.getElementById('daily-img');
        const loader = document.getElementById('daily-loader');
        const desc = document.getElementById('daily-desc');

        if(data) {
            desc.innerText = data.extract ? (data.extract.substring(0, 100) + "...") : "æš«ç„¡è©³ç´°ä»‹ç´¹ã€‚";
            const src = data.originalimage ? data.originalimage.source : (data.thumbnail ? data.thumbnail.source : null);
            if(src) {
                img.src = src;
                img.onload = () => { loader.style.display = 'none'; };
            } else {
                loader.style.display = 'none';
                img.alt = "No Image";
            }
        } else {
            loader.style.display = 'none';
            desc.innerText = "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚";
        }
    }


    // --- Modal ---
    async function openModal(bird) {
        const modal = document.getElementById('modal');
        const img = document.getElementById('m-img');
        const loader = document.getElementById('m-loader');
        
        modal.style.display = 'flex';
        img.style.display = 'none';
        loader.style.display = 'block';
        document.getElementById('m-err').style.display = 'none';
        
        document.getElementById('m-name').innerText = bird.name;
        document.getElementById('m-latin').innerText = bird.eng;
        document.getElementById('m-desc').innerText = "é€£ç·šç™¾ç§‘ä¸­...";
        document.getElementById('m-wiki').href = `https://zh.wikipedia.org/wiki/${bird.wikiTerm || bird.name}`;
        
        const badge = document.getElementById('m-status');
        badge.innerText = bird.status;
        badge.className = `status-badge ${getStatusClass(bird.status)}`;

        const data = await getWikiData(bird.name, bird.wikiTerm);
        if(data) {
            document.getElementById('m-desc').innerText = data.extract || "ç„¡è©³ç´°æ‘˜è¦";
            const src = data.originalimage ? data.originalimage.source : (data.thumbnail ? data.thumbnail.source : null);
            if(src) {
                img.src = src;
                img.onload = () => { loader.style.display='none'; img.style.display='block'; };
            } else {
                loader.style.display='none'; document.getElementById('m-err').style.display='block';
            }
        } else {
            loader.style.display='none';
            document.getElementById('m-desc').innerText = "è³‡æ–™è®€å–å¤±æ•—ã€‚";
        }
    }

    function closeModal(e) {
        if(!e || e.target.id === 'modal') {
            document.getElementById('modal').style.display = 'none';
        }
    }

    // --- Quiz ---
    let gameState = { pool: [], queue: [], idx: 0, score: 0, answering: false };
    let retryCount = 0;

    function startQuiz() {
        let pool = [...birds].sort(() => Math.random() - 0.5);
        gameState = { pool: pool, queue: pool.slice(0, 10), idx: 0, score: 0, answering: false };
        retryCount = 0;

        document.getElementById('quiz-menu').style.display = 'none';
        document.getElementById('quiz-result').style.display = 'none';
        document.getElementById('quiz-play').style.display = 'block';
        document.getElementById('q-score').innerText = 0;
        loadQuestion();
    }

    async function loadQuestion() {
        if(gameState.idx >= 10) { finishQuiz(); return; }
        
        const bird = gameState.queue[gameState.idx];
        gameState.answering = true;

        document.getElementById('q-progress').innerText = `${gameState.idx+1} / 10`;
        document.getElementById('reveal-card').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('feedback').innerText = '';
        document.getElementById('skip-indicator').style.display = 'none';
        document.getElementById('q-img').style.display = 'none';
        document.getElementById('v-loader').style.display = 'block';

        const data = await getWikiData(bird.name, bird.wikiTerm);
        const src = data && (data.originalimage ? data.originalimage.source : (data.thumbnail ? data.thumbnail.source : null));
        
        if(!src) {
            handleSkip();
            return;
        }

        const img = document.getElementById('q-img');
        img.src = src;
        img.onload = () => {
            document.getElementById('v-loader').style.display = 'none';
            img.style.display = 'block';
            retryCount = 0;
        };
        img.onerror = () => { handleSkip(); }

        let opts = [bird];
        let pool = birds.filter(b => b.name !== bird.name);
        for(let i=0; i<3; i++) opts.push(pool.splice(Math.floor(Math.random() * pool.length), 1)[0]);
        opts.sort(() => Math.random() - 0.5);

        document.getElementById('opt-container').innerHTML = opts.map(b => 
            `<button class="opt-btn" onclick="checkAnswer(this, '${b.name}')">${b.name}</button>`
        ).join('');
    }

    function handleSkip() {
        retryCount++;
        if(retryCount > 10) {
            alert("ç¶²è·¯ç‹€æ³ä¸ä½³");
            quitQuiz();
            return;
        }
        let replacementIndex = 10 + retryCount; 
        if(replacementIndex < gameState.pool.length) {
            gameState.queue[gameState.idx] = gameState.pool[replacementIndex];
            document.getElementById('skip-indicator').style.display = 'block';
            loadQuestion();
        } else {
            finishQuiz();
        }
    }

    function checkAnswer(btn, name) {
        if(!gameState.answering) return;
        gameState.answering = false;
        
        const correct = gameState.queue[gameState.idx];
        const isRight = name === correct.name;
        
        if(isRight) {
            btn.classList.add('correct');
            document.getElementById('feedback').innerText = "â­• ç­”å°äº†ï¼";
            document.getElementById('feedback').style.color = "green";
            gameState.score += 10;
        } else {
            btn.classList.add('wrong');
            document.getElementById('feedback').innerText = `âŒ æ˜¯ï¼š${correct.name}`;
            document.getElementById('feedback').style.color = "red";
            document.querySelectorAll('.opt-btn').forEach(b => {
                if(b.innerText === correct.name) b.classList.add('correct');
            });
        }
        document.getElementById('q-score').innerText = gameState.score;
        document.getElementById('next-btn').style.display = 'block';

        const rev = document.getElementById('reveal-card');
        rev.style.display = 'block';
        document.getElementById('rev-name').innerText = correct.name;
        document.getElementById('rev-link').href = `https://zh.wikipedia.org/wiki/${correct.wikiTerm || correct.name}`;
        
        const badge = document.getElementById('rev-status');
        badge.innerText = correct.status;
        badge.className = `status-badge ${getStatusClass(correct.status)}`;

        getWikiData(correct.name, correct.wikiTerm).then(d => document.getElementById('rev-desc').innerText = d ? d.extract : "ç„¡è³‡æ–™");
    }

    function nextQuestion() {
        gameState.idx++;
        loadQuestion();
    }

    function finishQuiz() {
        document.getElementById('quiz-play').style.display = 'none';
        document.getElementById('quiz-result').style.display = 'block';
        document.getElementById('final-score').innerText = gameState.score;
        
        let rank = "";
        if(gameState.score === 100) rank = "ğŸ† å°ç£é³¥ç¥";
        else if(gameState.score >= 80) rank = "ğŸ¦… è³é³¥é”äºº";
        else if(gameState.score >= 60) rank = "ğŸŒ² æ£®æ—è§€å¯Ÿå“¡";
        else rank = "ğŸ£ è³é³¥æ–°æ‰‹";
        document.getElementById('final-rank').innerText = rank;
    }

    function quitQuiz() {
        document.getElementById('quiz-play').style.display = 'none';
        document.getElementById('quiz-result').style.display = 'none';
        document.getElementById('quiz-menu').style.display = 'block';
    }
</script>

</body>
</html>